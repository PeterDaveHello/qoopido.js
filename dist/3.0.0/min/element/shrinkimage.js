(function(t,e){"use strict";var n=function n(){return e.qoopido.shared.module.initialize("element/shrinkimage",t,arguments)};"function"==typeof define&&define.amd?define(["../element","../function/merge","../url","../unique","../support","../support/capability/datauri","../support/element/canvas/todataurl/png"],n):n(e.qoopido.element,e.qoopido.function.merge,e.qoopido.url,e.qoopido.unique,e.qoopido.support,null,null)})(function(t,e,n,r,i,o,l,u,a,c){"use strict";function s(t,r){t=n.resolve(j.exec(t)[1]),r=r?!0:!1;var o=this,l=e({},o._settings,n.getParameter(t)),u=l.target||(t=t.split("?")[0]).replace(E,"".concat(".q",l.quality,".shrunk"));r||o.removeAttribute(o._settings.attribute).hide(),i.testMultiple("/capability/datauri","/element/canvas/todataurl/png").then(l.debug).then(function(){switch(typeof b[u]){case"object":b[u].one(P,function(t){f.call(o,t.data,r)}),o.emit(S);break;case"string":f.call(o,b[u],r);break;default:b[u]=v.create(u,r?null:o._element).one(k,function(e){e.type===P?(b[u]=e.data,o.emit(A),f.call(o,e.data,r)):(b[u]=t,f.call(o,t,r))},!1),o.emit(q)}}).fail(function(){b[u]=t,f.call(o,t,r)}).done()}function f(t,e){var n=this;e?n.setStyle("background-image","url("+t+")"):n.setAttribute("src",t).show(),n.emit(P),n.off()}function p(t){var e=this;t.get(e._url).then(function(t){try{var n=JSON.parse(t.data);n.width=parseInt(n.width,10),n.height=parseInt(n.height,10),d.call(e,n)}catch(r){e.emit(x)}},function(){e.emit(x)}).done()}function d(t){var e,n,r=this,i=function i(i){return e=_.pop()||c.createElement("canvas"),e.style.display="none",e.width=t.width,e.height=t.height,n=e.getContext("2d"),n.clearRect(0,0,t.width,t.height),n.drawImage(r.element,0,0,t.width,t.height),r.one(C,o).setAttribute("src",t.alpha),h(i)},o=function o(i){var o;return n.globalCompositeOperation="xor",n.drawImage(r.element,0,0,t.width,t.height),o=e.toDataURL("image/png"),l(),r.emit(P,o),h(i)},l=function l(){e&&_.push(e),r.element.stash&&w.push(r.removeAttribute("src").element)};r.one(z,function(t){t.type===C?i.call(this,t):(l(),r.emit(x))},!1).setAttribute("src",t.main)}function h(t){return t.preventDefault(),t.stopPropagation(),!1}var m,v,g=u.pop(),y={attribute:"data-"+g,quality:80,debug:!1},b={},_=[],w=[],O=RegExp('^url\\x28"{0,1}data:image/shrink,(.+?)"{0,1}\\x29$',"i"),j=RegExp('^(?:url\\x28"{0,1}|)(?:data:image/shrink,|)(.+?)(?:"{0,1}\\x29|)$',"i"),E=RegExp("\\.png$","i"),q="requested",S="queued",A="cached",P="loaded",x="failed",k="".concat(P," ",x),C="load",T="error",z="".concat(C," ",T);return m=t.extend({_constructor:function(t,n){var r,i,o=this;m._parent._constructor.call(o,t),o._settings=n=e({},y,n),r=o.getAttribute(n.attribute),i=o.getStyle("background-image"),"IMG"===o.type&&s.call(o,r),"none"!==i&&O.test(i)&&s.call(o,i,!0)},hide:function(){this.setStyles({visibility:"hidden",opacity:0})},show:function(){this.setStyles({visibility:"",opacity:""})}}),v=t.extend({_url:null,_constructor:function(t,e){var n=this;e||(e=w.pop()||c.createElement("img"),e.stash=!0),m._parent._constructor.call(n,e),n._url=t,"function"==typeof define&&define.amd?require(["../../transport/xhr"],function(t){p.call(n,t)}):p.call(n,a.qoopido.transport.xhr)}}),m},window);