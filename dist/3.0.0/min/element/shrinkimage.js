(function(t,e){"use strict";function n(){return e.qoopido.shared.module.initialize("element/shrinkimage",t)}"function"==typeof define&&define.amd?(e.JSON&&JSON.parse&&define("json",function(){return e.JSON}),define(["../element","../function/merge","../url","../support","../support/capability/datauri","../support/element/canvas/todataurl/png"],n)):n()})(function(t,e,n,r){"use strict";function i(e,n){e=t.url.resolve(g.exec(e)[1]),n=n?!0:!1;var r=this,i=t.function.merge({},r._settings,t.url.getParameter(e)),l=i.target||(e=e.split("?")[0]).replace(y,"".concat(".q",i.quality,".shrunk"));n||r.removeAttribute(r._settings.attribute).hide(),t.support.testMultiple("/capability/datauri","/element/canvas/todataurl/png").then(i.debug).then(function(){switch(typeof d[l]){case"object":d[l].one(O,function(t){o.call(r,t.data,n)}),r.emit(_);break;case"string":o.call(r,d[l],n);break;default:d[l]=s.create(l,n?null:r._element).one(E,function(t){t.type===O?(d[l]=t.data,r.emit(w),o.call(r,t.data,n)):(d[l]=e,o.call(r,e,n))},!1),r.emit(b)}}).fail(function(){d[l]=e,o.call(r,e,n)}).done()}function o(t,e){var n=this;e?n.setStyle("background-image","url("+t+")"):n.setAttribute("src",t).show(),n.emit(O),n.off()}function l(t){var e=this;t.get(e._url).then(function(t){try{var n=JSON.parse(t.data);n.width=parseInt(n.width,10),n.height=parseInt(n.height,10),u.call(e,n)}catch(r){e.emit(j)}},function(){e.emit(j)}).done()}function u(t){var e,n,i=this,o=function(o){return e=h.pop()||r.createElement("canvas"),e.style.display="none",e.width=t.width,e.height=t.height,n=e.getContext("2d"),n.clearRect(0,0,t.width,t.height),n.drawImage(i.element,0,0,t.width,t.height),i.one(S,l).setAttribute("src",t.alpha),c(o)},l=function(r){var o;return n.globalCompositeOperation="xor",n.drawImage(i.element,0,0,t.width,t.height),o=e.toDataURL("image/png"),u(),i.emit(O,o),c(r)},u=function(){e&&h.push(e),i.element.stash&&m.push(i.removeAttribute("src").element)};i.one(P,function(t){t.type===S?o.call(this,t):(u(),i.emit(j))},!1).setAttribute("src",t.main)}function c(t){return t.preventDefault(),t.stopPropagation(),!1}var a,s,f=e.pop(),p={attribute:"data-"+f,quality:80,debug:!1},d={},h=[],m=[],v=RegExp('^url\\x28"{0,1}data:image/shrink,(.+?)"{0,1}\\x29$',"i"),g=RegExp('^(?:url\\x28"{0,1}|)(?:data:image/shrink,|)(.+?)(?:"{0,1}\\x29|)$',"i"),y=RegExp("\\.png$","i"),b="requested",_="queued",w="cached",O="loaded",j="failed",E="".concat(O," ",j),S="load",A="error",P="".concat(S," ",A);return a=t.element.extend({_constructor:function(e,n){var r,o,l=this;a._parent._constructor.call(l,e),l._settings=n=t.function.merge({},p,n),r=l.getAttribute(n.attribute),o=l.getStyle("background-image"),"IMG"===l.type&&i.call(l,r),"none"!==o&&v.test(o)&&i.call(l,o,!0)},hide:function(){this.setStyles({visibility:"hidden",opacity:0})},show:function(){this.setStyles({visibility:"",opacity:""})}}),s=t.element.extend({_url:null,_constructor:function(t,e){var i=this;e||(e=m.pop()||r.createElement("img"),e.stash=!0),a._parent._constructor.call(i,e),i._url=t,"function"==typeof define&&define.amd?require(["../../transport/xhr","json"],function(t){l.call(i,t)}):l.call(i,n.qoopido.transport.xhr)}}),a},window);