(function(t,e){"use strict";function n(){return e.qoopido.shared.module.initialize("element/shrinkimage",t,arguments)}"function"==typeof define&&define.amd?(e.JSON&&JSON.parse&&define("json",function(){return e.JSON}),define(["../element","../function/merge","../url","../support","../support/capability/datauri","../support/element/canvas/todataurl/png","../transport/xhr","json"],n)):n()})(function(t,e,n,r,i){"use strict";function o(e,n){e=t.url.resolve(_.exec(e)[1]),n=n?!0:!1;var r=this,i=t.function.merge({},r._settings,t.url.getParameter(e)),o=i.target||(e=e.split("?")[0]).replace(v,"".concat(".q",i.quality,".shrunk"));n||r.removeAttribute(r._settings.attribute).hide(),t.support.testMultiple("/capability/datauri","/element/canvas/todataurl/png").then(i.debug).then(function(){switch(typeof h[o]){case"object":h[o].one(j,function(t){a.call(r,t.data,n)}),r.emit(w);break;case"string":a.call(r,h[o],n);break;default:h[o]=f.create(o,n?null:r._element).one(x,function(t){t.type===j?(h[o]=t.data,r.emit(O),a.call(r,t.data,n)):(h[o]=e,a.call(r,e,n))},!1),r.emit(b)}}).fail(function(){h[o]=e,a.call(r,e,n)}).done()}function a(t,e){var n=this;e?n.setStyle("background-image","url("+t+")"):n.setAttribute("src",t).show(),n.emit(j),n.off()}function l(t){var e=this;t.get(e._url).then(function(t){try{var n=JSON.parse(t.data);n.width=parseInt(n.width,10),n.height=parseInt(n.height,10),u.call(e,n)}catch(r){e.emit(P)}},function(){e.emit(P)}).done()}function u(t){var e,n,r=this,o=function(o){return e=m.pop()||i.createElement("canvas"),e.style.display="none",e.width=t.width,e.height=t.height,n=e.getContext("2d"),n.clearRect(0,0,t.width,t.height),n.drawImage(r.element,0,0,t.width,t.height),r.one(E,a).setAttribute("src",t.alpha),s(o)},a=function(i){var o;return n.globalCompositeOperation="xor",n.drawImage(r.element,0,0,t.width,t.height),o=e.toDataURL("image/png"),l(),r.emit(j,o),s(i)},l=function(){e&&m.push(e),r.element.stash&&g.push(r.removeAttribute("src").element)};r.one(k,function(t){t.type===E?o.call(this,t):(l(),r.emit(P))},!1).setAttribute("src",t.main)}function s(t){return t.preventDefault(),t.stopPropagation(),!1}var c,f,p=n.pop(),d={attribute:"data-"+p,quality:80,debug:!1},h={},m=[],g=[],y=RegExp('^url\\x28"{0,1}data:image/shrink,(.+?)"{0,1}\\x29$',"i"),_=RegExp('^(?:url\\x28"{0,1}|)(?:data:image/shrink,|)(.+?)(?:"{0,1}\\x29|)$',"i"),v=RegExp("\\.png$","i"),b="requested",w="queued",O="cached",j="loaded",P="failed",x="".concat(j," ",P),E="load",S="error",k="".concat(E," ",S);return c=t.element.extend({_constructor:function(e,n){var r,i,a=this;c._parent._constructor.call(a,e),a._settings=n=t.function.merge({},d,n),r=a.getAttribute(n.attribute),i=a.getStyle("background-image"),"IMG"===a.type&&o.call(a,r),"none"!==i&&y.test(i)&&o.call(a,i,!0)},hide:function(){this.setStyles({visibility:"hidden",opacity:0})},show:function(){this.setStyles({visibility:"",opacity:""})}}),f=t.element.extend({_url:null,_constructor:function(t,e){var n=this;e||(e=g.pop()||i.createElement("img"),e.stash=!0),c._parent._constructor.call(n,e),n._url=t,l.call(n,r.qoopido.transport.xhr)}}),c},window);