(function(e,t){"use strict";function n(){return t.qoopido.shared.module.initialize("element/shrinkimage",e)}"function"==typeof define&&define.amd?(t.JSON&&JSON.parse&&define("json",function(){return t.JSON}),define(["../element","../function/merge","../url","../support","../support/capability/datauri","../support/element/canvas/todataurl/png"],n)):n()})(function(e,t,n,r){"use strict";function i(t,n){t=e.url.resolve(g.exec(t)[1]),n=n?!0:!1;var r=this,i=e.function.merge({},r._settings,e.url.getParameter(t)),l=i.target||(t=t.split("?")[0]).replace(v,"".concat(".q",i.quality,".shrunk"));n||r.removeAttribute(r._settings.attribute).hide(),e.support.testMultiple("/capability/datauri","/element/canvas/todataurl/png").then(i.debug).then(function(){switch(typeof d[l]){case"object":d[l].one(O,function(e){o.call(r,e.data,n)}),r.emit(b);break;case"string":o.call(r,d[l],n);break;default:d[l]=s.create(l,n?null:r._element).one(P,function(e){e.type===O?(d[l]=e.data,r.emit(w),o.call(r,e.data,n)):(d[l]=t,o.call(r,t,n))},!1),r.emit(_)}}).fail(function(){d[l]=t,o.call(r,t,n)}).done()}function o(e,t){var n=this;t?n.setStyle("background-image","url("+e+")"):n.setAttribute("src",e).show(),n.emit(O),n.off()}function l(e){var t=this;e.get(t._url).then(function(e){try{var n=JSON.parse(e.data);n.width=parseInt(n.width,10),n.height=parseInt(n.height,10),u.call(t,n)}catch(r){t.emit(j)}},function(){t.emit(j)}).done()}function u(e){var t,n,i=this,o=function(o){return t=h.pop()||r.createElement("canvas"),t.style.display="none",t.width=e.width,t.height=e.height,n=t.getContext("2d"),n.clearRect(0,0,e.width,e.height),n.drawImage(i.element,0,0,e.width,e.height),i.one(E,l).setAttribute("src",e.alpha),c(o)},l=function(r){var o;return n.globalCompositeOperation="xor",n.drawImage(i.element,0,0,e.width,e.height),o=t.toDataURL("image/png"),u(),i.emit(O,o),c(r)},u=function(){t&&h.push(t),i.element.stash&&m.push(i.removeAttribute("src").element)};i.one(A,function(e){e.type===E?o.call(this,e):(u(),i.emit(j))},!1).setAttribute("src",e.main)}function c(e){return e.preventDefault(),e.stopPropagation(),!1}var a,s,f=t.pop(),p={attribute:"data-"+f,quality:80,debug:!1},d={},h=[],m=[],y=RegExp('^url\\x28"{0,1}data:image/shrink,(.+?)"{0,1}\\x29$',"i"),g=RegExp('^(?:url\\x28"{0,1}|)(?:data:image/shrink,|)(.+?)(?:"{0,1}\\x29|)$',"i"),v=RegExp("\\.png$","i"),_="requested",b="queued",w="cached",O="loaded",j="failed",P="".concat(O," ",j),E="load",S="error",A="".concat(E," ",S);return a=e.element.extend({_constructor:function(t,n){var r,o,l=this;a._parent._constructor.call(l,t),l._settings=n=e.function.merge({},p,n),r=l.getAttribute(n.attribute),o=l.getStyle("background-image"),"IMG"===l.type&&i.call(l,r),"none"!==o&&y.test(o)&&i.call(l,o,!0)},hide:function(){this.setStyles({visibility:"hidden",opacity:0})},show:function(){this.setStyles({visibility:"",opacity:""})}}),s=e.element.extend({_url:null,_constructor:function(e,t){var i=this;t||(t=m.pop()||r.createElement("img"),t.stash=!0),a._parent._constructor.call(i,t),i._url=e,"function"==typeof define&&define.amd?require(["../../transport/xhr","json"],function(e){l.call(i,e)}):l.call(i,n.qoopido.transport.xhr)}}),a},window);