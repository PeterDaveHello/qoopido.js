(function(t,e){"use strict";function n(){return e.qoopido.initialize("dom/element/shrinkimage",t,arguments)}"function"==typeof define&&define.amd?(e.JSON&&JSON.parse&&define("json",function(){return e.JSON}),define(["../element","../../proxy","../../function/merge","../../url","../../support","../../support/capability/datauri","../../support/element/canvas/todataurl/png","../../transport/xhr","json"],n)):n()})(function(t,e,n,i,r){"use strict";function o(e,n){e=t.url.resolve(_.exec(e)[1]),n=n?!0:!1;var i=this,r=t["function/merge"]({},i._settings,t.url.getParameter(e)),o=r.target||(e=e.split("?")[0]).replace(y,"".concat(".q",r.quality,".shrunk"));n||i.removeAttribute(i._settings.attribute).hide(),t.support.testMultiple("/capability/datauri","/element/canvas/todataurl/png").then(r.debug).then(function(){switch(typeof p[o]){case"object":p[o].one(E,function(t){a.call(i,t.data,n)}),i.emit(w);break;case"string":a.call(i,p[o],n);break;default:p[o]=f.create(o,n?null:i._element).one(q,function(t){t.type===E?(p[o]=t.data,i.emit(x),a.call(i,t.data,n)):(p[o]=e,a.call(i,e,n))},!1),i.emit(b)}}).fail(function(){p[o]=e,a.call(i,e,n)}).done()}function a(t,e){var n=this;e?n.setStyle("background-image","url("+t+")"):n.one(A,function(){n.show(),n.emit(E),n.off()}).setAttribute("src",t)}function l(t){var e=this;t.get(e._url).then(function(t){try{var n=JSON.parse(t.data);n.width=parseInt(n.width,10),n.height=parseInt(n.height,10),s.call(e,n)}catch(i){e.emit(S)}},function(){e.emit(S)}).done()}function s(t){var e,n,i=this,o=function(o){return e=h.pop()||r.createElement("canvas"),e.style.display="none",e.width=t.width,e.height=t.height,n=e.getContext("2d"),n.clearRect(0,0,t.width,t.height),n.drawImage(i.element,0,0,t.width,t.height),i.one(A,a).setAttribute("src",t.alpha),u(o)},a=function(r){var o;return n.globalCompositeOperation="xor",n.drawImage(i.element,0,0,t.width,t.height),o=e.toDataURL("image/png"),l(),i.emit(E,o),u(r)},l=function(){e&&h.push(e),i.element.stash&&g.push(i.removeAttribute("src").element)};i.one(k,function(t){t.type===A?o.call(this,t):(l(),i.emit(S))},!1).setAttribute("src",t.main)}function u(t){return t.preventDefault(),t.stopPropagation(),!1}var c,f,d=n.pop(),m={attribute:"data-"+d,quality:80,debug:!1},p={},h=[],g=[],v=RegExp('^url\\x28"{0,1}data:image/shrink,(.+?)"{0,1}\\x29$',"i"),_=RegExp('^(?:url\\x28"{0,1}|)(?:data:image/shrink,|)(.+?)(?:"{0,1}\\x29|)$',"i"),y=RegExp("\\.png$","i"),b="requested",w="queued",x="cached",E="loaded",S="failed",q="".concat(E," ",S),A="load",z="error",k="".concat(A," ",z);return c=t["dom/element"].extend({_constructor:function(e,n){var i,r,a=this;c._parent._constructor.call(a,e),a._settings=n=t["function/merge"]({},m,n),i=a.getAttribute(n.attribute),r=a.getStyle("background-image"),"IMG"===a.type&&o.call(a,i),"none"!==r&&v.test(r)&&o.call(a,r,!0)},hide:function(){this.setStyles({visibility:"hidden",opacity:0})},show:function(){this.setStyles({visibility:"",opacity:""})}}),f=t["dom/element"].extend({_url:null,_constructor:function(e,n){var i=this;n||(n=g.pop()||r.createElement("img"),n.stash=!0),c._parent._constructor.call(i,n),i._url=e,l.call(i,t["transport/xhr"])}}),c},window);