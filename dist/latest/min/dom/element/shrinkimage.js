(function(t,e){"use strict";function n(){return e.qoopido.initialize("dom/element/shrinkimage",t,arguments)}"function"==typeof define&&define.amd?(e.JSON&&JSON.parse&&define("json",function(){return e.JSON}),define(["../element","../../proxy","../../function/merge","../../url","../../support","../../support/capability/datauri","../../support/element/canvas/todataurl/png","../../transport/xhr","../../pool/dom","json"],n)):n()})(function(t,e,n,i){"use strict";function r(e,n){e=t.url.resolve(h.exec(e)[1]),n=n?!0:!1;var i=this,r=t["function/merge"]({},i._settings,t.url.getParameter(e)),a=r.target||(e=e.split("?")[0]).replace(g,"".concat(".q",r.quality,".shrunk"));n||i.removeAttribute(i._settings.attribute).hide(),t.support.testMultiple("/capability/datauri","/element/canvas/todataurl/png").then(r.debug).then(function(){switch(typeof m[a]){case"object":m[a].one(b,function(t){o.call(i,t.data,n)}),i.emit(_);break;case"string":o.call(i,m[a],n);break;default:m[a]=c.create(a,n?null:i._element).one(x,function(t){t.type===b?(m[a]=t.data,i.emit(y),o.call(i,t.data,n)):(m[a]=e,o.call(i,e,n))},!1),i.emit(v)}}).fail(function(){m[a]=e,o.call(i,e,n)}).done()}function o(t,e){var n=this;e?n.setStyle("background-image","url("+t+")"):n.one(E,function(){n.show(),n.emit(b),n.off()}).setAttribute("src",t)}function a(t){var e=this;t.get(e._url).then(function(t){try{var n=JSON.parse(t.data);n.width=parseInt(n.width,10),n.height=parseInt(n.height,10),l.call(e,n)}catch(i){e.emit(w)}},function(){e.emit(w)}).done()}function l(t){var e,n,r=this,o=function(o){return e=i.qoopido.shared.pool.dom.obtain("canvas"),e.style.display="none",e.width=t.width,e.height=t.height,n=e.getContext("2d"),n.clearRect(0,0,t.width,t.height),n.drawImage(r.element,0,0,t.width,t.height),r.one(E,a).setAttribute("src",t.alpha),s(o)},a=function(i){var o;return n.globalCompositeOperation="xor",n.drawImage(r.element,0,0,t.width,t.height),o=e.toDataURL("image/png"),l(),r.emit(b,o),s(i)},l=function(){e&&e.dispose(),r.element._quid&&r.element.dispose&&r.element.dispose()};r.one(S,function(t){t.type===E?o.call(this,t):(l(),r.emit(w))},!1).setAttribute("src",t.main)}function s(t){return t.preventDefault(),t.stopPropagation(),!1}var u,c,f=n.pop(),d={attribute:"data-"+f,quality:80,debug:!1},m={},p=RegExp('^url\\x28"{0,1}data:image/shrink,(.+?)"{0,1}\\x29$',"i"),h=RegExp('^(?:url\\x28"{0,1}|)(?:data:image/shrink,|)(.+?)(?:"{0,1}\\x29|)$',"i"),g=RegExp("\\.png$","i"),v="requested",_="queued",y="cached",b="loaded",w="failed",x="".concat(b," ",w),E="load",q="error",S="".concat(E," ",q);return u=t["dom/element"].extend({_constructor:function(e,n){var i,o,a=this;u._parent._constructor.call(a,e),a._settings=n=t["function/merge"]({},d,n),i=a.getAttribute(n.attribute),o=a.getStyle("background-image"),"IMG"===a.type&&r.call(a,i),"none"!==o&&p.test(o)&&r.call(a,o,!0)},hide:function(){this.setStyles({visibility:"hidden",opacity:0})},show:function(){this.setStyles({visibility:"",opacity:""})}}),c=t["dom/element"].extend({_url:null,_constructor:function(e,n){var r=this;n||(n=i.qoopido.shared.pool.dom.obtain("img")),u._parent._constructor.call(r,n),r._url=e,a.call(r,t["transport/xhr"])}}),u},window);