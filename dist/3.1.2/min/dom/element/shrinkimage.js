(function(t){window.qoopido.register("dom/element/shrinkimage",t,["../element","../../proxy","../../function/merge","../../url","../../support","../../support/capability/datauri","../../support/element/canvas/todataurl/png","../../transport/xhr","../../pool/dom","json"])})(function(t,e,n){"use strict";function i(e,n){e=t.url.resolve(g.exec(e)[1]),n=n?!0:!1;var i=this,o=t["function/merge"]({},i._settings,t.url.getParameter(e)),a=o.target||(e=e.split("?")[0]).replace(h,"".concat(".q",o.quality,".shrunk"));n||i.removeAttribute(i._settings.attribute).hide(),t.support.testMultiple("/capability/datauri","/element/canvas/todataurl/png").then(o.debug).then(function(){switch(typeof p[a]){case"object":p[a].one(y,function(t){r.call(i,t.data,n)}),i.emit(m);break;case"string":r.call(i,p[a],n);break;default:p[a]=u.create(a,n?null:i._element).one(b,function(t){t.type===y?(p[a]=t.data,i.emit(v),r.call(i,t.data,n)):(p[a]=e,r.call(i,e,n))},!1)}}).fail(function(){p[a]=e,r.call(i,e,n)}).done()}function r(t,e){var n=this;e?(n.element.style.backgroundImage="url("+t+")",n.emit(y),n.off()):n.one(w,function(){n.show(),n.emit(y),n.off()}).setAttribute("src",t)}function o(t){var e=this;t.get(e._url).done(function(t){try{var n=JSON.parse(t.data);n.width=parseInt(n.width,10),n.height=parseInt(n.height,10),a.call(e,n)}catch(i){e.emit(_)}},function(){e.emit(_)})}function a(t){var n,i,r=this,o=function(o){return n=e.pool.dom.obtain("canvas"),n.style.display="none",n.width=t.width,n.height=t.height,i=n.getContext("2d"),i.clearRect(0,0,t.width,t.height),i.drawImage(r.element,0,0,t.width,t.height),r.one(w,a).setAttribute("src",t.alpha),l(o)},a=function(e){var o;return i.globalCompositeOperation="xor",i.drawImage(r.element,0,0,t.width,t.height),o=n.toDataURL("image/png"),s(),r.emit(y,o),l(e)},s=function(){n&&n.dispose(),r.element._quid&&r.element.dispose&&r.element.dispose()};r.one(E,function(t){t.type===w?o.call(this,t):(s(),r.emit(_))},!1).setAttribute("src",t.main)}function l(t){return t.preventDefault(),t.stopPropagation(),!1}var s,u,c=n.pop(),f={attribute:"data-"+c,quality:80,debug:!1},p={},d=RegExp('^url\\x28"{0,1}data:image/shrink,(.+?)"{0,1}\\x29$',"i"),g=RegExp('^(?:url\\x28"{0,1}|)(?:data:image/shrink,|)(.+?)(?:"{0,1}\\x29|)$',"i"),h=RegExp("\\.png$","i"),m="queued",v="cached",y="loaded",_="failed",b="".concat(y," ",_),w="load",x="error",E="".concat(w," ",x);return s=t["dom/element"].extend({_constructor:function(e,n){var r,o,a=this;s._parent._constructor.call(a,e),a._settings=n=t["function/merge"]({},f,n),r=a.getAttribute(n.attribute),o=a.element.style.backgroundImage,"IMG"===a.type&&i.call(a,r),"none"!==o&&d.test(o)&&i.call(a,o,!0)},hide:function(){this.setStyles({visibility:"hidden",opacity:0})},show:function(){this.setStyles({visibility:"",opacity:""})}}),u=t["dom/element"].extend({_url:null,_constructor:function(n,i){var r=this;i||(i=e.pool.dom.obtain("img")),s._parent._constructor.call(r,i),r._url=n,o.call(r,t["transport/xhr"])}}),s});